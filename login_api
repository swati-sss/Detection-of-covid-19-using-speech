import Foundation
import Combine
import UIKit
import LivingDesign

// MARK: - StoreMapState Enum

enum StoreMapState {
    case loading(Bool) // Indicates if the map is loading.
    case warning       // Represents a warning state.
    case error         // Represents an error state
}

// MARK: - MapStateModel Struct

struct MapStateModel {
    // Warning State Properties
    var warningImage: UIImage?
    var warningText: String
    var warningTryAgainText: String
    var warningButtonIcon: LDIconValue
    var warningButtonText: String

    // Error State Properties
    var errorImage: UIImage?
    var errorText: String
    var errorTryAgainText: String
    var errorButtonText: String

    init(warningImage: UIImage? = Asset.Image.mapWarning.image,
         warningText: String = LocalizedKey.mapNotAvailableCheckInternet.localized,
         warningTryAgainText: String = LocalizedKey.mapNotAvailable.localized,
         warningButtonIcon: LDIconValue = .primitive(.refresh),
         warningButtonText: String = LocalizedKey.reload.localized,
         errorImage: UIImage? = Asset.Image.mapError.image,
         errorText: String = LocalizedKey.errorLoadingMap.localized,
         errorTryAgainText: String = LocalizedKey.errorLoadingMapTryAgain.localized,
         errorButtonText: String = LocalizedKey.reloadMap.localized) {
        self.warningImage = warningImage
        self.warningText = warningText
        self.warningTryAgainText = warningTryAgainText
        self.warningButtonIcon = warningButtonIcon
        self.warningButtonText = warningButtonText
        self.errorImage = errorImage
        self.errorText = errorText
        self.errorTryAgainText = errorTryAgainText
        self.errorButtonText = errorButtonText
    }
}

// MARK: - StoreMapReloadDelegate Protocol

protocol StoreMapReloadDelegate: AnyObject {
    /// Called when map reload is requested
    func reloadStoreMap()
}

// MARK: - StoreMapStatesViewController Class

class StoreMapStatesViewController: LDRootViewController {
    var storeMapState: StoreMapState = .loading(true)
    weak var storeMapReloadDelegate: StoreMapReloadDelegate?

    private var mapStateModel: MapStateModel
    private var warningStackView: UIStackView = {
        let stackView = UIStackView()
        stackView.axis = .vertical
        stackView.alignment = .center
        stackView.spacing = LDSpacing.space12 + LDSpacing.space2
        return stackView
    }()
    private var warningImageView: UIImageView = UIImageView()
    private var warningTitleLabel: UILabel = UILabel()
    private let warningButton: LDLinkButton = {
        let button = LDLinkButton(dataModel: LDLinkButton.Model(size: .large))
        return button
    }()
    private let errorAlert: LDAlert = {
        let alert = LDAlert(
            dataModel: LDAlert.Model(message: NSAttributedString(string: ""),
                                     messageType: .error)
        )
        return alert
    }()
    private var errorMapImageView: UIImageView = UIImageView()
    private lazy var spinner: LDSpinner = {
        let spinner = LDSpinner(style: .neutral, size: .small)
        spinner.hidesWhenStopped = true
        spinner.isUserInteractionEnabled = false
        spinner.stopAnimating()
        return spinner
    }()
    // Change attempts to internal for test access
    var attempts = 0
    private var cancellable = Set<AnyCancellable>()

    init(mapStateModel: MapStateModel) {
        self.mapStateModel = mapStateModel
        super.init(nibName: nil, bundle: nil)

        applyMapStateModel()
    }

    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }

    override func constructView() {
        super.constructView()

        warningButton.addTarget(self, action: #selector(reloadMapButtonTapped), for: .primaryActionTriggered)
    }

    override func constructSubviewLayoutConstraints() {
        super.constructSubviewLayoutConstraints()

        spinner.translatesAutoresizingMaskIntoConstraints = false

        view.backgroundColor = .white
        view.addAutoLayoutSubview(spinner)
        view.bringSubviewToFront(spinner)
        view.addAutoLayoutSubview(warningStackView)
        view.addAutoLayoutSubview(errorAlert)
        view.addAutoLayoutSubview(errorMapImageView)

        warningStackView.addArrangedSubview(warningImageView)
        warningStackView.addArrangedSubview(warningTitleLabel)
        warningStackView.addArrangedSubview(warningButton)

        NSLayoutConstraint.activate([
            spinner.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            spinner.centerYAnchor.constraint(equalTo: view.centerYAnchor),
            spinner.widthAnchor.constraint(equalToConstant: LDSpacing.space24),
            spinner.heightAnchor.constraint(equalToConstant: LDSpacing.space24),
            warningStackView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            warningStackView.centerYAnchor.constraint(equalTo: view.centerYAnchor),
            warningStackView.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space24),
            warningStackView.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space24),
            warningImageView.widthAnchor.constraint(equalToConstant: LDSpacing.space40+LDSpacing.space2),
            warningImageView.heightAnchor.constraint(equalToConstant: LDSpacing.space32+LDSpacing.space4),
            warningButton.heightAnchor.constraint(equalToConstant: LDSpacing.space32+LDSpacing.space4),
            errorAlert.topAnchor.constraint(equalTo: view.topAnchor, constant: LDSpacing.space16),
            errorAlert.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space8),
            errorAlert.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space8),
            errorMapImageView.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            errorMapImageView.centerYAnchor.constraint(equalTo: view.centerYAnchor),
            errorMapImageView.widthAnchor.constraint(equalToConstant: LDSpacing.space32),
            errorMapImageView.heightAnchor.constraint(equalToConstant: LDSpacing.space32)
        ])
    }

    func updateMapDisplayForState() {
        switch storeMapState {
        case .loading(let show):
            Log.info("Map State loading with value \(show)")
            spinner.isHidden = !show
            toggleLoadingSpinner()
            warningStackView.isHidden = true
            errorMapImageView.isHidden = true
            errorAlert.isHidden = true
            view.isHidden = !show
        case .warning:
            Log.info("Map State warning")
            spinner.isHidden = true
            toggleLoadingSpinner()
            warningStackView.isHidden = false
            errorMapImageView.isHidden = true
            errorAlert.isHidden = true
            view.isHidden = false
        case .error:
            Log.info("Map State error")
            spinner.isHidden = true
            toggleLoadingSpinner()
            warningStackView.isHidden = true
            errorMapImageView.isHidden = false
            errorAlert.isHidden = false
            view.isHidden = false
        }
    }

    @objc func reloadMapButtonTapped() {
        Log.info("Reload Map")
        let maxAttempts = 5
        attempts += 1
        if attempts > maxAttempts {
            startCooldown()
        } else {
            storeMapReloadDelegate?.reloadStoreMap()
        }
    }
}

private extension StoreMapStatesViewController {
    func applyMapStateModel() {
        spinner.isHidden = true

        warningStackView.distribution = .equalCentering
        warningStackView.isHidden = true

        warningImageView.image = mapStateModel.warningImage
        warningImageView.contentMode = .scaleAspectFit

        warningTitleLabel.text = mapStateModel.warningText
        warningTitleLabel.textAlignment = .center
        warningTitleLabel.numberOfLines = 0
        warningTitleLabel.textColor = UIColor(
            red: 0.18, green: 0.184, blue: 0.196, alpha: 1
        )
        warningTitleLabel.font = UIFont.bogle(
            ofSize: LivingDesign.LDSpacing.space12 + LivingDesign.LDSpacing.space2,
            weight: .regular
        )

        warningButton.dataModel = LDLinkButton.Model(
            size: .small,
            text: mapStateModel.warningButtonText,
            variant: .subtle,
            leadingImage: resolveIcon(mapStateModel.warningButtonIcon)
        )
        warningButton.addTarget(self, action: #selector(reloadMapButtonTapped), for: .primaryActionTriggered)

        let errorAlertAttributed = NSAttributedString(string: mapStateModel.errorText)
        errorAlert.dataModel =  LivingDesign.LDAlert.Model(
            message: errorAlertAttributed,
            messageType: .error,
            detailsButtonTitle: mapStateModel.errorButtonText)
        errorAlert.isHidden = true
        errorAlert.onTapAlert = { [weak self] in
            self?.reloadMapButtonTapped()
        }

        errorMapImageView.image = mapStateModel.errorImage
        errorMapImageView.contentMode = .scaleAspectFit
        errorMapImageView.isHidden = true
    }

    func toggleLoadingSpinner() {
        guard spinner.isHidden else {
            spinner.startAnimating()
            return
        }

        spinner.stopAnimating()
    }

    func startCooldown() {
        // 5 minutes cool for warning state view
        // 3 minutes cool for error state view
        let cooldownPeriod: TimeInterval =  errorAlert.isHidden ? (5 * 60) : (3 * 60)
        setReloadMap(isHidden: false)

        DispatchQueue.main.asyncAfter(deadline: .now() + cooldownPeriod) { [weak self] in
            self?.attempts = 0
            self?.setReloadMap(isHidden: true)
        }
    }

    func setReloadMap(isHidden: Bool) {
        let warningText = mapStateModel.warningText
        let warningTryAgainText = mapStateModel.warningTryAgainText

        let errorText = mapStateModel.errorText
        let errorTryAgainText = mapStateModel.errorTryAgainText
        let errorButtonText = mapStateModel.errorButtonText

        warningTitleLabel.text = isHidden ? warningText : warningTryAgainText
        warningButton.isEnabled = isHidden

        let errorAlertAttributed = NSAttributedString(string: isHidden ? errorText : errorTryAgainText)
        errorAlert.dataModel =  LivingDesign.LDAlert.Model(
            message: errorAlertAttributed,
            messageType: .error,
            detailsButtonTitle: isHidden ? errorButtonText : ""
        )
    }

    private func resolveIcon(_ icon: LDIconValue) -> UIImage {
        var tokens = LivingDesign.LDToken(
            in: Bundle(for: LDRootViewController.self),
            for: "LDToken"
        )
        tokens.update(with: traitCollection)
        return icon.resolve(with: tokens)
    }
}
