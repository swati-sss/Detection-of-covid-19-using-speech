import XCTest
import Combine
import CoreData
import Foundation

@testable import compass_sdk_ios

@_implementationOnly import IPSFramework

final class CompassViewModelTests: XCTestCase {
    private var walmartMapStoreConfig: StoreConfig!
    private var oriientMapStoreConfig: StoreConfig!
    private var walmartMapStoreConfigWithoutBlueDot: StoreConfig!
    private var emptyStoreConfig: StoreConfig!
    private var compassViewModel: CompassViewModel!
    private var userAccessTokenResponse: AccessTokenResponse!
    private var iamAccessTokenResponse: AccessTokenResponse!
    private var userAuthParameter: AuthParameter!
    private var iamAuthParameter: AuthParameter!
    private var statusService: StatusService!
    private let containerViewController = UIViewController()
    private var cancellables = Set<AnyCancellable>()
    private var serviceLocator: ServiceLocatorType!
    private var networkService: MockNetworkService!

    override func setUpWithError() throws {
        try super.setUpWithError()
        serviceLocator = MockServiceLocator()
        networkService = serviceLocator.getNetworkService() as? MockNetworkService
        compassViewModel = CompassViewModel(serviceLocator: serviceLocator)
        guard let compassViewModel else {
            return
        }
        compassViewModel.rootViewController = containerViewController
        compassViewModel.canCompleteInitialization = { true }
        statusService = serviceLocator.getStatusService()
        userAccessTokenResponse = AccessTokenResponse(
            accessToken: "MTAyOTYyMDE4dSxyrP0t1Jm+zsHDj/m58lYEBSWPPQT0ASxP67P/p/R/XCviMJx6YIyuweMm/D4szCyTMBgQUr8MJWMSm3S2rqgF8Z3ooqOrbfBJzORYy7wGmKcywYDpRHb13NVCvU9dVoZ2h67qtmWCX5xnAS95ZSpQBIV+q5odNqvzV1gAYlvCveWZ0+3rq3ePWs9LhzZ7tXoVX6MbrQS+QrPDOp+Ee8FAqtMt7lzQdJSvbzFlrGCMSMVOB6MAabmTP67qQX6SO9FaZQ9xSvIHt7THYc5BH11KK3aFtE5QbXB6Vt5ZAzN3ltf8skOawMmpueLResLhye4vrf8JNA1nW1zzpx3kxQ==",
            tokenType: "user",
            expiresIn: 900
        )
        iamAccessTokenResponse = AccessTokenResponse(
            accessToken: "Uhcqt1EBCq3COum7WhGK4b0Pre0TyMndfqMsCslnzyd70Zc5Xy1NI-pyCARRNG0qQvkI2iVv2s7sKGBiTwz_PQ",
            tokenType: "IAM",
            expiresIn: 900
        )
        userAuthParameter = AuthParameter(
            authToken: userAccessTokenResponse.accessToken,
            tokenType: userAccessTokenResponse.tokenType,
            accountID: "988sdd-erer-43434",
            consumerID: "573e4372-b4f0-4f01-a58d-3f7aff19e078"
        )
        iamAuthParameter = AuthParameter(
            authToken: iamAccessTokenResponse.accessToken,
            tokenType: iamAccessTokenResponse.tokenType,
            accountID: "988sdd-erer-43434",
            consumerID: "c061c52a-b978-4ae9-9875-6584e58e8a74"
        )
        walmartMapStoreConfig = StoreConfig(supportedEventList: "\"[{ \"event_namespace\": \"MODFLEX_SCAN_FEATURE_LOCATION\",  \"enabled\": true,  \"batched\": false},{ \"event_namespace\": \"MODFLEX_CREATE_FEATURE_ITEM\", \"enabled\": true,  \"batched\": false},{ \"even_namespace\":\"MODFLEX_SET_MOD_SECTION_FEATURE\",  \"enabled\": true, \"batched\\\": false},{ \"event_namespace\":\"MODFLEX_SET_MOD_SECTION_FEATURE\", \"enabled\": true, \"batched\": false},{\"event_namespace\":\"MODFLEX_SCAN_OTHER_FEATURE_ITEMS\", \"enabled\": true, \"batched\": false},{\"event_namespace\": \"SFOT_ITEM_SCAN\", \"enabled\": true, \"batched\": false},{\"event_namespace\": \"SFOT_ITEM_SCAN\", \"enabled\": true, \"batched\": false},{\"event_namespace\": \"SFOT_ITEM_ADD_TO_CART\", \"enabled\": true,  \"batched\": false},{\"event_namespace\": \"SFOT_ITEM_ORDERED\",  \"enabled\": true,  \"batched\": false}]\"",
                                            storeId: Int(2280),
                                            valid: true,
                                            bluedotEnabled: true,
                                            mapType: "WalmartMap",
                                            sessionRefreshTime: 900,
                                            offset: StoreConfigOffset(
                                                x: 4612.4299902343755,
                                                y: 3431.0000244140624
                                            ),
                                            geofenceRadius: 100.0,
                                            latitude: 36.3585,
                                            longitude: -94.2098,
                                            createdAt: 1660137139000,
                                            updatedAt: 1660137139000,
                                            analytics: true,
                                            batchInterval: 180000,
                                            heartbeatInterval: 3000)
        walmartMapStoreConfigWithoutBlueDot = StoreConfig(storeId: Int(3594),
                                                          valid: true,
                                                          bluedotEnabled: false,
                                                          mapType: "WalmartMap",
                                                          sessionRefreshTime: 900,
                                                          offset: StoreConfigOffset(
                                                            x: 70.2500012207031,
                                                            y: 1953.1300146484375
                                                          ),
                                                          analytics: true,
                                                          batchInterval: 180000,
                                                          heartbeatInterval: 3000)
        oriientMapStoreConfig = StoreConfig(storeId: Int(2280),
                                            valid: true,
                                            bluedotEnabled: true,
                                            mapType: "OriientMap",
                                            sessionRefreshTime: 900,
                                            offset: StoreConfigOffset(
                                                x: 4612.4299902343755,
                                                y: 3431.0000244140624
                                            ),
                                            geofenceRadius: 100.0,
                                            latitude: 36.3585,
                                            longitude: -94.2098,
                                            createdAt: 1660137139000,
                                            updatedAt: 1660137139000,
                                            analytics: true,
                                            batchInterval: 180000,
                                            heartbeatInterval: 3000)
        emptyStoreConfig = StoreConfig(storeId: Int(3594),
                                       valid: true,
                                       bluedotEnabled: false,
                                       sessionRefreshTime: 900,
                                       analytics: true)
    }

    override func tearDownWithError() throws {
        (serviceLocator as? MockServiceLocator)?._resetMock()
        cancellables.removeAll()
        try super.tearDownWithError()
    }

    func testGetAccessTokenWhenAuthTokenIsEmpty() {
        compassViewModel.getAccessToken(authParameter: AuthParameter())
            .replaceEmpty(with: nil)
            .sink { accessTokenResponse in
                XCTAssertNil(accessTokenResponse)
            }
            .store(in: &cancellables)
    }

    func testGetAccessTokenWhenTokenTypeIsUser() {
        compassViewModel.getAccessToken(authParameter: userAuthParameter)
            .sink { [weak self] accessTokenResponse in
                XCTAssertNotNil(self)
                XCTAssertNotNil(accessTokenResponse)
                XCTAssertEqual(accessTokenResponse!.tokenType, "user")
                XCTAssertEqual(accessTokenResponse?.accessToken, self!.userAuthParameter.authToken)
            }
            .store(in: &cancellables)
    }

    func testGetAccessTokenWhenTokenTypeIsIAM() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.getAccessToken(authParameter: iamAuthParameter)
            .sink { accessTokenResponse in
                XCTAssertNotNil(accessTokenResponse)
                XCTAssertEqual(accessTokenResponse!.tokenType, "User")
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testGetAccessTokenFailed() {
        let expectation = expectation (description: #function)
        networkService._expectedError = ErrorResponse(response: HTTPURLResponse(url: TestData.exampleURL, statusCode: 520, httpVersion: "1.1", headerFields: [:])!, error: MockNetworkServiceError.requestFailed)
        networkService._shouldFail = true
        statusService.eventEmitterHandler = { eventEmitter in
            guard let errorEventEmitter = eventEmitter as? ErrorEventEmitter else {
                return
            }
            if errorEventEmitter.eventType == .initErrorEventEmitter {
                expectation.fulfill()
            }
        }

        compassViewModel.getAccessToken(authParameter: AuthParameter(authToken: "invalidToken", tokenType: "IAM"))
            .sink { XCTAssertNil($0) }
            .store(in: &cancellables)

        waitForExpectations(timeout: 5.0)
    }

    func testToggleMockUserWhenMockUserIsTrue() {
        compassViewModel.toggleMockUser(true)
        XCTAssertEqual(IPSPositioning.testLockThreshold, 0)
    }

    func testUpdateStoreConfigurationWhenStoreConfigIsEmpty() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(emptyStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.emptyStoreConfig.storeId!)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testUpdateStoreConfigurationForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.x,  self!.walmartMapStoreConfig.offset?.x)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.y,  self!.walmartMapStoreConfig.offset?.y)
                XCTAssertEqual(Log.batchInterval,  self!.walmartMapStoreConfig.batchInterval!/1000)
                XCTAssertEqual(Analytics.heartbeatInterval,  self!.walmartMapStoreConfig.heartbeatInterval!/1000)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testUpdateStoreConfigurationForOriientMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.oriientMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.oriientMapStoreConfig.mapType?.lowercased())
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.x,  self!.oriientMapStoreConfig.offset?.x)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.y,  self!.oriientMapStoreConfig.offset?.y)
                XCTAssertEqual(Log.batchInterval,  self!.oriientMapStoreConfig.batchInterval!/1000)
                XCTAssertEqual(Analytics.heartbeatInterval,  self!.oriientMapStoreConfig.heartbeatInterval!/1000)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testUpdateStoreConfigurationForWalmartMapWithoutBlueDot() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfigWithoutBlueDot)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfigWithoutBlueDot.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfigWithoutBlueDot.mapType?.lowercased())
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.x,  self!.walmartMapStoreConfigWithoutBlueDot.offset?.x)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeConfigOffset.y,  self!.walmartMapStoreConfigWithoutBlueDot.offset?.y)
                XCTAssertEqual(Log.batchInterval,  self!.walmartMapStoreConfigWithoutBlueDot.batchInterval!/1000)
                XCTAssertEqual(Analytics.heartbeatInterval,  self!.walmartMapStoreConfigWithoutBlueDot.heartbeatInterval!/1000)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testSetBackgroundModeWhenBackgroundModeIsTrue() {
        let notificationCenter = NotificationCenter.default
        notificationCenter.post(name: UIApplication.didEnterBackgroundNotification, object: nil, userInfo: nil)
        XCTAssertEqual((serviceLocator.getNetworkMonitorService() as? MockNetworkMonitorService)?._isBackgroundMode, true)
        XCTAssertFalse(serviceLocator.getIndoorPositioningService().isPositioningActive)
    }

    func testSetBackgroundModeForBlueDotWhenBackgroundModeAndIsPositioningActiveIsFalse() {
        let notificationCenter = NotificationCenter.default
        notificationCenter.post(name: UIApplication.willEnterForegroundNotification, object: nil, userInfo: nil)
        XCTAssertEqual((serviceLocator.getNetworkMonitorService() as? MockNetworkMonitorService)?._isBackgroundMode, false)
    }

    func testGetAisleWithAssetIdForWalmartMap() {
        let exp = XCTestExpectation(description: #function)

        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.getAisle(id: "peter123")
                XCTAssertEqual((self!.serviceLocator.getAssetService() as? MockAssetService)!._evaluateAssetsCalled, true)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 5.0)
    }

//    func testGetAisleWithAssetIdForOriientMap() {
//        let exp = XCTestExpectation(description: #function)
//        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
//            .sink { [weak self] _ in
//                XCTAssertNotNil(self)
//                self!.compassViewModel.getAisle(id: "peter123")
//                XCTAssertEqual((self!.serviceLocator.getAssetService() as? MockAssetService)!._evaluateAssetsCalled, true)
//                exp.fulfill()
//            }
//            .store(in: &cancellables)
//        wait(for: [exp], timeout: 5.0)
//    }

    func testGetAisleWithAssetIdForWalmartMapWithoutBlueDot() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfigWithoutBlueDot)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.getAisle(id: "peter123")
                XCTAssertEqual((self!.serviceLocator.getAssetService() as? MockAssetService)!._evaluateAssetsCalled, true)
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 5.0)
    }

    func testIsMapViewReady() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.isMapViewReady()
            .dropFirst()
            .sink { isMapViewReady in
                XCTAssert(isMapViewReady)
                exp.fulfill()
            }
            .store(in: &cancellables)

        compassViewModel.updateStoreConfiguration(TestData.storeConfig)
            .sink { _ in }.store(in: &cancellables)
        self.compassViewModel.displayMap()

        wait(for: [exp], timeout: 5.0)
    }

    func testDisplayMapWhenIsPositioningActiveFalse() {
        compassViewModel.displayMap()
        XCTAssertFalse(serviceLocator.getIndoorPositioningService().isPositioningActive)
    }

    func testDisplayMapForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.displayMap()
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testDisplayMapForWalmartMapWithoutBlueDot() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfigWithoutBlueDot)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.displayMap()
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfigWithoutBlueDot.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfigWithoutBlueDot.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testDisplayMapForOriientMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.displayMap()
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.oriientMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.oriientMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testClearMapForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let mapConfig = MapConfig(resetZoom: true)
                self!.compassViewModel.clearMap(mapConfig: mapConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testClearMapForOriientMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let mapConfig = MapConfig(resetZoom: true)
                self!.compassViewModel.clearMap(mapConfig: mapConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.oriientMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.oriientMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testUpdateEventForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.lastLockedPosition = MockIPSPosition(x: 10, y: 20, headingAngle: MockIPSHeading(angle: 3.142), accuracy: 5)
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.floorCoordinatesConverter = MockFloorCoordinatesConverterImpl()
        compassViewModel = CompassViewModel(serviceLocator: serviceLocator)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let compassEvent = CompassEvent(eventType: "asset_scan",
                                                eventValue: "575208",
                                                eventMetadata: [:])
                self!.compassViewModel.updateEvent(compassEvent: compassEvent)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testUpdateEventForOriientMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let compassEvent = CompassEvent(eventType: "asset_scan",
                                                eventValue: "575208",
                                                eventMetadata: [:])
                self!.compassViewModel.updateEvent(compassEvent: compassEvent)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.oriientMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.oriientMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testUpdateEventListForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.lastLockedPosition = MockIPSPosition(x: 10, y: 20, headingAngle: MockIPSHeading(angle: 3.142), accuracy: 5)
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.floorCoordinatesConverter = MockFloorCoordinatesConverterImpl()
        let assetService = serviceLocator.getAssetService() as? MockAssetService
        assetService?.supportedEventList = walmartMapStoreConfig.supportedEventList ?? ""
        compassViewModel = CompassViewModel(serviceLocator: serviceLocator)
        compassViewModel.updateEventList(
            namespace: "modflex",
            eventType: "MODFLEX_SCAN_FEATURE_LOCATION",
            eventValue: "BK4-12",
            metaData: [
                "keyA": "va",
                "keyB": "vb",
                "keyC": "vc",
                "keyD": "vd",
                "keyE": "ve",
                "keyF": "vf"
            ]
        )
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testDisplayPinWithMultipleUUIdForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let displayPinConfig = DisplayPinConfig(enableManualPinDrop: false, resetZoom:true, shouldZoomOnPins: true)
                self!.compassViewModel.displayPin(uuidList: ["1645190", "575207", "575208"],
                                                  idType: PinDropMethod.assets,
                                                  config: displayPinConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                XCTAssertNotNil(UserDefaults.standard.object(forKey: UserDefaultsKey.uuidList.rawValue) as? [String])
                XCTAssertEqual(UserDefaults.standard.object(forKey: UserDefaultsKey.uuidList.rawValue) as? [String], ["1645190", "575207", "575208"])
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testDisplayPinWithUUIdForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let displayPinConfig = DisplayPinConfig(enableManualPinDrop: false, resetZoom:true, shouldZoomOnPins: true)
                self!.compassViewModel.displayPin(uuidList: ["575208"],
                                                  idType: PinDropMethod.assets,
                                                  config: displayPinConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                XCTAssertNotNil(UserDefaults.standard.object(forKey: UserDefaultsKey.uuidList.rawValue) as? [String])
                XCTAssertEqual(UserDefaults.standard.object(forKey: UserDefaultsKey.uuidList.rawValue) as? [String], ["575208"])
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testdisplayPinForWalmartMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let displayPinConfig = DisplayPinConfig(enableManualPinDrop: false, resetZoom:true, shouldZoomOnPins: true)
                let aislePin1 = AislePin(type: "item", id: "1", location: AisleLocation(zone: "A", aisle: "3", section: "3", selected: true))
                let aislePin2 = AislePin(type: "item", id: "2", location: AisleLocation(zone: "A", aisle: "8", section: "3", selected: false))
                let compassPins: [CompassPin] = [aislePin1, aislePin2].map { CompassPin.aisle($0) }
                self!.compassViewModel.displayPin(pins: compassPins, config: displayPinConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testdisplayPinForOriientMap() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(oriientMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let displayPinConfig = DisplayPinConfig(enableManualPinDrop: false, resetZoom:true, shouldZoomOnPins: true)
                let aislePin1 = AislePin(type: "item", id: "1", location: AisleLocation(zone: "A", aisle: "3", section: "3", selected: true))
                let aislePin2 = AislePin(type: "item", id: "2", location: AisleLocation(zone: "A", aisle: "8", section: "3", selected: false))
                let compassPins: [CompassPin] = [aislePin1, aislePin2].map { CompassPin.aisle($0) }
                self!.compassViewModel.displayPin(pins: compassPins, config: displayPinConfig)
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.oriientMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.oriientMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testResetPositionStatusEvent() {
        let exp = XCTestExpectation(description: #function)
        statusService.eventEmitterHandler = { eventEmitter in
            guard let positionEventEmitter = eventEmitter as? PositionEventEmitter else {
                return
            }
            XCTAssertEqual(positionEventEmitter.eventType, .positionEventEmitter)
            exp.fulfill()
        }
        compassViewModel.resetPositionStatusEvent()
        wait(for: [exp], timeout: 2.0)
    }
    
    func testStopPositioningWhenIsPositioningEnabledIsFalse() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfigWithoutBlueDot)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.stopPositioning()
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfigWithoutBlueDot.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfigWithoutBlueDot.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testStopPositioningWhenIsPositioningEnabledIsTrue() {
        let exp = XCTestExpectation(description: #function)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.compassViewModel.stopPositioning()
                XCTAssertEqual(self!.serviceLocator.getAssetService().storeId, self!.walmartMapStoreConfig.storeId!)
                XCTAssertEqual(self!.serviceLocator.getAssetService().mapType.rawValue.lowercased(), self!.walmartMapStoreConfig.mapType?.lowercased())
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    func testUpdateEvent_whenFloorCoordinatesConverterIsNil_shouldEmitErrorAndAnalytics() {
        let exp = XCTestExpectation(description: #function)
        // Set lastLockedPosition to non-nil
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.lastLockedPosition = MockIPSPosition(x: 10, y: 20, headingAngle: MockIPSHeading(angle: 3.142), accuracy: 5)
        // Set floorCoordinatesConverter to nil
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.floorCoordinatesConverter = nil
        compassViewModel = CompassViewModel(serviceLocator: serviceLocator)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                let compassEvent = CompassEvent(eventType: "asset_scan", eventValue: "575208", eventMetadata: [:])
                self!.statusService.eventEmitterHandler = { eventEmitter in
                    guard let errorEventEmitter = eventEmitter as? ErrorEventEmitter else { return }
                    XCTAssertEqual(errorEventEmitter.eventType, .errorEventEmitter)
                    XCTAssertEqual(errorEventEmitter.compassErrorType, CompassErrorType.addEventError.rawValue)
                    exp.fulfill()
                }
                self!.compassViewModel.updateEvent(compassEvent: compassEvent)
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    func testUpdateEventList_whenAllGuardsPass_shouldEmitUpdateEventList() {
        let exp = XCTestExpectation(description: #function)
        // Set up mocks
        let mockPosition = MockIPSPosition(x: 10, y: 20, headingAngle: MockIPSHeading(angle: 1.23), accuracy: 5)
        mockPosition.lockProgress = 1
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.lastPosition.value = mockPosition
        (serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.floorCoordinatesConverter = MockFloorCoordinatesConverterImpl()
        compassViewModel = CompassViewModel(serviceLocator: serviceLocator)
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                XCTAssertNotNil(self)
                self!.statusService.eventEmitterHandler = { eventEmitter in
                    // You can add more specific assertions here if needed
                    exp.fulfill()
                }
                self!.compassViewModel.updateEventList(
                    namespace: "modflex",
                    eventType: "feature_scan",
                    eventValue: "BK4-12",
                    metaData: ["keyA": "va"]
                )
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }
    
    func testKillSwitchCallsDependenciesAndClearsCancellables() {
        // Call killSwitch
        compassViewModel.killSwitch()

        // Assert stopPositioning and logout are called (using the mock)
        XCTAssertTrue((serviceLocator.getUserPositionManager() as? MockUserPositionManager)?._logoutCalled == true)
    }
    
    func testUpdateEventList_fullBlockIsCovered() {
        let exp = expectation(description: "updateEventList full block is covered")
        // Setup: Use a store config with bluedotEnabled = true
        compassViewModel.updateStoreConfiguration(walmartMapStoreConfig)
            .sink { [weak self] _ in
                guard let self = self else { return }
                // Make sure supportedEventList contains the event you will use
                if let mockAssetService = self.serviceLocator.getAssetService() as? MockAssetService {
                    mockAssetService.supportedEventList = """
                    {\"namespace\":\"modflex\",\"eventType\":\"feature_scan\",\"enabled\": true},
                    """
                }
                // Set up mocks for position and converter
                let mockPosition = MockIPSPosition(x: 10, y: 20, headingAngle: MockIPSHeading(angle: 1.23), accuracy: 5)
                (self.serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.lastLockedPosition = mockPosition
                (self.serviceLocator.getIndoorPositioningService() as? MockIndoorPositioningService)?.floorCoordinatesConverter = MockFloorCoordinatesConverterImpl()
                // Call the method
                self.compassViewModel.updateEventList(
                    namespace: "modflex",
                    eventType: "feature_scan",
                    eventValue: "BK4-12",
                    metaData: ["keyA": "va"]
                )
                // No assertion needed, just ensure code is executed
                exp.fulfill()
            }
            .store(in: &cancellables)
        wait(for: [exp], timeout: 2.0)
    }

    func testInitializeWithInvalidConfigurationSetsFinishedFalse() {
        let expectation = expectation(description: #function)
        compassViewModel.isFinishedInitializePublisher
            .sink { value in
                if value == false {
                    expectation.fulfill()
                }
            }
            .store(in: &cancellables)

        var invalidConfiguration = TestData.configuration
        invalidConfiguration.site = 0

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: invalidConfiguration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        wait(for: [expectation], timeout: 2.0)
    }

    func testInitializeWhenConfigFetchFailsEmitsFalse() {
        let expectation = expectation(description: #function)
        let mockConfigurationService = serviceLocator.getConfigurationService() as? MockConfigurationService
        mockConfigurationService?._shouldGetConfigPayloadFail = true

        compassViewModel.isFinishedInitializePublisher
            .sink { value in
                if value == false {
                    expectation.fulfill()
                }
            }
            .store(in: &cancellables)

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: TestData.configuration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        wait(for: [expectation], timeout: 5.0)
    }

    func testInitializeWhenConfigFetchFailsWithNonErrorEmitsFalse() {
        let expectation = expectation(description: #function)
        let mockConfigurationService = serviceLocator.getConfigurationService() as? MockConfigurationService
        mockConfigurationService?._shouldGetConfigPayloadFail = true
        mockConfigurationService?._errorToThrow = NSError(domain: "Test", code: 1, userInfo: nil)

        compassViewModel.isFinishedInitializePublisher
            .sink { value in
                if value == false {
                    expectation.fulfill()
                }
            }
            .store(in: &cancellables)

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: TestData.configuration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        wait(for: [expectation], timeout: 5.0)
    }

    func testInitializeWhenDeleteEventsFailsStillFinishes() {
        let expectation = expectation(description: #function)
        let eventStoreService = serviceLocator.getEventStoreService() as? MockEventStoreService
        eventStoreService?._shouldFail = true
        let mapFocusManager = serviceLocator.getMapFocusManager() as? MockMapFocusManager
        mapFocusManager?.isMapViewPresent.send(true)

        compassViewModel.isFinishedInitializePublisher
            .sink { value in
                if value == true {
                    expectation.fulfill()
                }
            }
            .store(in: &cancellables)

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: TestData.configuration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        wait(for: [expectation], timeout: 5.0)
    }

    func testInitializeEmitsFinishedSettingMapWhenMapReady() {
        let expectation = expectation(description: #function)
        let mapFocusManager = serviceLocator.getMapFocusManager() as? MockMapFocusManager
        mapFocusManager?.isMapViewPresent.send(true)

        compassViewModel.isFinishedSettingMapPublisher
            .sink { value in
                if value {
                    expectation.fulfill()
                }
            }
            .store(in: &cancellables)

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: TestData.configuration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        wait(for: [expectation], timeout: 5.0)
    }

    func testInitializeAsMockUserTogglesMockSettings() {
        var configuration = TestData.configuration
        configuration.mockUser = true
        IPSPositioning.testLockThreshold = 1

        compassViewModel.initialize(authParameter: TestData.authParameter,
                                    configuration: configuration,
                                    capabilities: [.storeMap],
                                    customMapRequest: nil)

        XCTAssertEqual(IPSPositioning.testLockThreshold, 0)
    }
}
