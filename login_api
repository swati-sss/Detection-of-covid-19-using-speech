import SwiftUI

struct AislePinRow: Identifiable, Equatable {
    let id = UUID()
    var zone: String = "A"
    var aisle: String = "1"
    var section: String = "1"
    var selected: Bool = true
}

struct AislePinInputSheet: View {
    @SwiftUI.Environment(\.dismiss) private var dismiss

    @State private var rows: [AislePinRow] = [AislePinRow()]
    let maxRows: Int = 5

    private let zoneOptions: [String] = (65...90).compactMap { UnicodeScalar($0).map { String($0) } }
    private let numberOptions: [String] = (1...20).map { String($0) }

    var onDisplayPin: (_ pins: [(zone: String, aisle: String, section: String, selected: Bool)]) -> Void

    var body: some View {
        NavigationStack {
            ScrollView {
                VStack(spacing: 12) {
                    ForEach($rows) { $row in
                        HStack(spacing: 8) {
                            Picker("Zone", selection: $row.zone) {
                                ForEach(zoneOptions, id: \.self) { option in
                                    Text(option).tag(option)
                                }
                            }
                            .pickerStyle(.menu)
                            .frame(width: 80)

                            Picker("Aisle", selection: $row.aisle) {
                                ForEach(numberOptions, id: \.self) { option in
                                    Text(option).tag(option)
                                }
                            }
                            .pickerStyle(.menu)
                            .frame(width: 80)

                            Picker("Section", selection: $row.section) {
                                ForEach(numberOptions, id: \.self) { option in
                                    Text(option).tag(option)
                                }
                            }
                            .pickerStyle(.menu)
                            .frame(width: 80)

                            Toggle("Selected", isOn: $row.selected)
                                .labelsHidden()

                            Button {
                                removeRow(row)
                            } label: {
                                Image(systemName: "trash")
                            }
                            .buttonStyle(.borderless)
                            .disabled(rows.count == 1)
                        }
                    }

                    HStack {
                        Button {
                            addRow()
                        } label: {
                            Label("Add Row", systemImage: "plus.circle")
                        }
                        .disabled(rows.count >= maxRows)

                        Spacer()
                    }
                }
                .padding()
            }
            .navigationTitle("Aisle Pins")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("Cancel") { dismiss() }
                }
                ToolbarItem(placement: .confirmationAction) {
                    Button("Display Pins") {
                        let tuples = rows.map { ($0.zone, $0.aisle, $0.section, $0.selected) }
                        onDisplayPin(tuples)
                        dismiss()
                    }
                    .disabled(rows.isEmpty)
                }
            }
        }
    }

    private func addRow() {
        guard rows.count < maxRows else { return }
        rows.append(AislePinRow())
    }

    private func removeRow(_ row: AislePinRow) {
        if let idx = rows.firstIndex(of: row), rows.count > 1 {
            rows.remove(at: idx)
        }
    }
}
