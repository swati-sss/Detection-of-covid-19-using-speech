import XCTest
@testable import compass_sdk_ios

@_implementationOnly import IPSFramework

final class CompassTests: XCTestCase {
    private var compass: Compass!
    private var serviceLocator: MockServiceLocator!
    private var viewModel: MockCompassViewModel!
    
    override func setUpWithError() throws {
        serviceLocator = MockServiceLocator()
        viewModel = MockCompassViewModel()
        compass = Compass(serviceLocator: serviceLocator, viewModel: viewModel)
    }
    
    override func tearDownWithError() throws {
        serviceLocator = nil
        viewModel = nil
        compass = nil
    }
    
    func testViewDidAppear() {
        compass.viewDidAppear(false)
        
        XCTAssert(viewModel._startPositionSessionCalled)
    }
    
    func testInitialize() throws {
        let authParameter = TestData.authParameter
        let configuration = TestData.configuration
        let rootViewController = UIViewController()

        compass.initialize(authParameter: authParameter, configuration: configuration, capabilities: [.storeMap], rootViewController: rootViewController)

        XCTAssertEqual(rootViewController.children, [compass.self])
        XCTAssert(viewModel._initializeCalled)
    }
    
    func testDisplayMap() throws {
        let workflow = Workflow(id: nil, type: "display map", value: "")
        
        compass.displayMap(workflow: workflow)
        DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(15)) {
            XCTAssertEqual(Analytics.workflow?.id, workflow.id)
            XCTAssertEqual(Analytics.workflow?.type, workflow.type)
            XCTAssertEqual(Analytics.workflow?.value, workflow.value)
        }
    }
    
    func testUpdateEvent() throws {
        guard let assetId = ["1645190", "575207", "575208"].shuffled().first else { return }
        let compassEvent = CompassEvent(eventType: "asset_scan", eventValue: assetId, eventMetadata: [:])
        
        compass?.updateEvent(compassEvent: compassEvent)
        
        XCTAssert(viewModel._updateEventCalled)
    }
    
    func testUpdateEventList() throws {
        compass?.updateEventList(
            namespace: "modflex",
            eventType: "feature_scan",
            eventValue: "BK4-12",
            metaData: [
                "keyA": "va",
                "keyB": "vb",
                "keyC": "vc",
                "keyD": "vd",
                "keyE": "ve",
                "keyF": "vf"
            ]
        )
        
        XCTAssert(viewModel._updateEventListCalled)
    }
    
    func testDisplayPinForGeneric() throws {
        let config = ["enableManualPinDrop": true]
        
        compass?.displayPin(uuidList: ["YzAvWy12SixmWF0vMQ=="], idType: .generic, config: config)
        
        XCTAssert(viewModel._displayPinCalled)
    }
    
    func testDisplayPinForAssets() throws {
        let config = ["enableManualPinDrop": true]
        
        compass?.displayPin(uuidList: ["12345", "123"], idType: .assets, config: config)
        
        XCTAssert(viewModel._displayPinCalled)
    }
    
    func testKillSwitch() throws {
        compass?.killSwitch()
        XCTAssert(viewModel._killSWitchCalled)
    }
    
    func testResetPositionStatusEvents() throws {
        compass?.resetPositionStatusEvent()
        XCTAssert(viewModel._resetPositionStatusEventCalled)
    }
    
    func testdisplayPin() throws {
        let aislePin1 = AislePin(type: "item", id: "1", location: AisleLocation(zone: "A", aisle: "3", section: "3", selected: true))
        let aislePin2 = AislePin(type: "item", id: "2", location: AisleLocation(zone: "A", aisle: "8", section: "3", selected: false))
        let displayPinConfig: HashMap = ["enableManualPinDrop": false, "resetZoom": true]
        
        let compassPins: [CompassPin] = [aislePin1, aislePin2].map { CompassPin.aisle($0) }
        compass?.displayPin(pins: compassPins, config: displayPinConfig)
        
        XCTAssert(viewModel._displayPinCalled)
    }
    
    func testClearMap() throws {
        compass.clearMap()
        
        XCTAssert(viewModel._clearMapCalled)
    }
    
    func testGetAisle() throws {
        compass.getAisle(id: "")
        
        XCTAssert(viewModel._getAisleCalled)
    }
    
    func testGetStatusService() throws {
        _ = compass?.getStatusService()
        
        XCTAssert(serviceLocator!._getStatusServiceCalled)
    }
    
    func testSetupEnvironment() throws {
        compass?.setEnvironment(.staging)
        
        XCTAssertEqual(NetworkManager.environment, .staging)
    }

    func testSetWebViewMessageDelegateDelegatesToViewModel() {
        compass?.setWebViewMessageDelegate(MockWebViewMessageDelegate())
        XCTAssertTrue(viewModel._setWebViewDelegateCalled)
    }

    func testEvaluateJSOnWebViewDelegatesToViewModel() {
        compass?.evaluateJSOnWebView("test()")
        XCTAssertTrue(viewModel._evaluateJSOnWebViewCalled)
    }
    
    func testUpdateAuthParams() throws {
        compass?.updateAuthParams(token: "", tokenType: TestData.accessTokenResponse.tokenType, consumerID: "", accountID: "")
        
        XCTAssertTrue(viewModel._updateAuthParamsCalled)
    }
    
    func test_handleEventsForBackgroundURLSession_shouldFailInitialization() throws {
        Compass.handleEventsForBackgroundURLSession(identifier: "SessionId", application: UIApplication.shared)
        guard let isFinishedInitialize = compass.isFinishedInitialize.value else {
            return
        }
        XCTAssert(isFinishedInitialize)
    }
    
    func testDefaultInit() {
        let compass = Compass()
        XCTAssertNotNil(compass)
    }
    
//    func testInitWithCoderTriggersFatalError() {
//        // This will crash the test, but will include the line in coverage
//        // You may want to comment this out after running coverage if you don't want a crash in CI
//        XCTAssertThrowsError(try { _ = Compass(coder: NSCoder()) }())
//    }
}

private final class MockWebViewMessageDelegate: WebViewMessageDelegate {
    func didReceiveWebViewMessage(_ message: String) {}
}
