import CoreGraphics
import Foundation
import Combine

enum ZoomTarget {
    case userLocation
    case pinAnnotation
}

class StoreMapLoaderViewModel {
    weak var mapViewDelegate: StoreMapsViewDelegate?
    let blueDotMode: BlueDotMode
    let userPositionManager: UserPositionManagement
    private(set) var navigationEnabled: Bool?
    private(set) var pinsConfig: PinsConfig

    var currentZoomScale: CGFloat = 0
    var lastPathfindingEnabled: Bool?
    var isStaticPathVisible = false
    var staticPathPreviewCancellable: AnyCancellable?
    var routeCancellable: AnyCancellable?
    var pinList: (current: PinList?, last: PinList?)
    var isPinDistanceFetched: Bool = false
    var pinLocationFetchCompletionHandler: PinLocationFetchCompletionHandler?
    var pinRenderCompletion: (([Pin]) -> Void)?
    var floorSelected = 0

    internal var assetService: AssetService
    internal var statusService: StatusService
    internal var indoorNavigationService: IndoorNavigationService
    internal var staticPathPreviewService: StaticPathPreviewService

    private(set) var indoorPositioningService: IndoorPositioningService
    private(set) var mapFocusManager: MapFocusManager
    private(set) var keychainService: KeychainServiceType
    private(set) var eventService: EventService
    private(set) var messageParser: MessageParsing
    private(set) var messageSender: MessageSending

    internal var mapData: MapData?
    internal var mapLoadedData: MapLoaded?
    internal var hasLoadedMapView = false
    internal var hasMapViewZoomed = false
    internal var renderedPins: [Pin] = []
    internal var renderedPinsZoomRect: CGRect?
    internal var mapDataReadyRequestTimer: Timer?

    private(set) var preferredZoomScale: CGFloat = StoreMapZoomLevel.third.minimumZoomScale
    private(set) var zoomAnalyticsLogger: ZoomAnalyticsLogger?
    private(set) var cancellable: [AnyCancellable] = []
    private(set) var callCount: Int = 0
    private(set) var lastLogTime: TimeInterval = 0

    lazy var navigationCoordinator = NavigationCoordinator(viewModel: self)
    lazy var pinRenderCoordinator = PinRenderCoordinator(
        viewModel: self,
        navigationCoordinator: navigationCoordinator
    )

    var config = DisplayPinConfig(
        enableManualPinDrop: true,
        resetZoom: false,
        shouldZoomOnPins: true
    )

    internal var configuration = StoreMapView.Configuration(
        isPinSelectionEnabled: false,
        pin: nil,
        preferredFloor: "1"
    )

    init(blueDotMode: BlueDotMode,
         pinsConfig: PinsConfig,
         navigationConfig: NavigationConfig?,
         serviceLocator: ServiceLocatorType,
         zoomAnalyticsLogger: ZoomAnalyticsLogger? = ZoomAnalyticsLogger(workflow: Analytics.workflow)) {
        self.pinsConfig = pinsConfig
        self.blueDotMode = blueDotMode
        self.navigationEnabled = navigationConfig?.enabled ?? false
        self.messageSender = serviceLocator.getWebViewMessageSender()
        self.messageParser = serviceLocator.getWebViewMessageParser()
        self.assetService = serviceLocator.getAssetService()
        self.statusService = serviceLocator.getStatusService()
        self.indoorPositioningService = serviceLocator.getIndoorPositioningService()
        self.indoorNavigationService = serviceLocator.getIndoorNavigationService()
        self.staticPathPreviewService = serviceLocator.getStaticPathPreviewService()
        self.indoorNavigationService.navigationConfig = navigationConfig
        self.userPositionManager = serviceLocator.getUserPositionManager()
        self.mapFocusManager = serviceLocator.getMapFocusManager()
        self.eventService = serviceLocator.getEventService()
        self.keychainService = serviceLocator.getKeychainService()
        self.messageParser.delegate = self
        self.zoomAnalyticsLogger = zoomAnalyticsLogger
        self.pinList = (current: nil, last: nil)
        self.indoorNavigationService.delegate = self
    }

    deinit {
        mapDataReadyRequestTimer?.invalidate()
        mapDataReadyRequestTimer = nil
        cancellable.removeAll()
        Log.info("Released StoreMapLoaderViewModel")
    }

#if DEBUG
    func updateConfiguration(pinsConfig: PinsConfig, navigationConfig: NavigationConfig?) {
        self.pinsConfig = pinsConfig
        navigationEnabled = navigationConfig?.enabled ?? false
        indoorNavigationService.navigationConfig = navigationConfig
    }
#endif
}
