import XCTest
import Combine
@testable import Compass

class IndoorMapViewModelTests: XCTestCase {
    var viewModel: IndoorMapViewModel!
    var cancellables: Set<AnyCancellable> = []
    var mockServiceLocator: MockServiceLocator!

    override func setUp() {
        super.setUp()
        mockServiceLocator = MockServiceLocator()
        viewModel = IndoorMapViewModel(blueDotMode: .default, serviceLocator: mockServiceLocator)
    }

    override func tearDown() {
        viewModel = nil
        mockServiceLocator = nil
        cancellables.removeAll()
        super.tearDown()
    }

    func testViewDidLoadCallsSetupMethods() {
        // This test will just call viewDidLoad to ensure no crash
        viewModel.viewDidLoad()
        // You can add expectations for Combine publishers if needed
    }

    func testDisplayMapViewPublishesEvent() {
        let expectation = self.expectation(description: "displayMapViewRequested should emit")
        var called = false
        viewModel.displayMapViewRequested
            .sink { _ in
                called = true
                expectation.fulfill()
            }
            .store(in: &cancellables)
        viewModel.displayMapView()
        waitForExpectations(timeout: 1)
        XCTAssertTrue(called)
    }

    func testOnCoordinateLongpressedWithManualPinDropDisabled() {
        viewModel.enableManualPinDrop = false
        viewModel.onCoordinateLongpressed(CGPoint(x: 1, y: 1), mapViewController: nil)
        // Should not add pin or crash
    }

    func testShowPinAddsPinItem() {
        // Set up a map id
        viewModel.map.value = IPSMap(id: "testMapId")
        viewModel.showPin(CGPoint(x: 2, y: 2))
        // No assertion here, but you can check internal state if needed
    }

    func testClearMapRemovesAllItems() {
        viewModel.clearMap()
        // No assertion here, but you can check internal state if needed
    }

    func testSetupFloorTransitionsItems_DirectionDown() {
        // Setup
        let mockFloor = MockIPSFloor(order: 2)
        let floorTransition = IPSRouteFloorTransition(
            id: "transition1",
            x: 1.0,
            y: 2.0,
            type: .stairs,
            floorOrder: 3,
            destinationFloorOrder: 2
        )
        let mockUserPositionManager = MockUserPositionManager()
        mockUserPositionManager.visibleFloor.value = mockFloor
        let viewModel = IndoorMapViewModel(blueDotMode: .default, serviceLocator: mockServiceLocator)
        viewModel.userPositionManager = mockUserPositionManager
        viewModel.routeFloorTransitions.value = [floorTransition]
        // Act
        viewModel.setupFloorTransitionsItems()
        // Assert
        let items = viewModel.floorTransitionsItems.value
        XCTAssertEqual(items.count, 1)
        XCTAssertEqual(items.first?.direction, .down)
    }
}

// MARK: - Mocks

class MockServiceLocator: ServiceLocatorType {
    func getIndoorPositioningService() -> IndoorPositioningService { MockIndoorPositioningService() }
    func getIndoorNavigationService() -> IndoorNavigationService { MockIndoorNavigationService() }
    func getMapFocusManager() -> MapFocusManager { MockMapFocusManager() }
    func getStatusService() -> StatusService { MockStatusService() }
    func getAssetService() -> AssetService { MockAssetService() }
    func getEventService() -> EventService { MockEventService() }
    func getUserPositionManager() -> UserPositionManagement { MockUserPositionManager() }
}

// Add minimal mock implementations for dependencies as needed
class MockIndoorPositioningService: IndoorPositioningService {
    var floorCoordinatesConverter: FloorCoordinatesConverter? { nil }
    func registerApplicationEvent(_ event: IPSApplicationEvent) {}
    func getMap(_ mapId: String, buildingId: String, floorId: String, onSuccess: @escaping (IPSMap) -> Void, onError: @escaping (Error) -> Void) {}
}
class MockIndoorNavigationService: IndoorNavigationService {
    var route: CurrentValueSubject<IPSRoute?, Never> = .init(nil)
    func startNavigation() {}
}
class MockMapFocusManager: MapFocusManager {
    var onMapFocusRequired: PassthroughSubject<MapFocus, Never> = .init()
    var isMapViewPresent: CurrentValueSubject<Bool, Never> = .init(false)
    func onMapInterServiceStarted() {}
    func onMapInterServiceEnded() {}
    func onUserFocusRequested() {}
}
class MockStatusService: StatusService {
    func emitMapStatusEvent(description: String) {}
    var bootstrapEventEmitter: ((CompassEvent) -> Void)?
}
class MockAssetService: AssetService {
    var idType: PinDropMethod = .assets
    var idList: [String] = []
    var assetEvents: [String] = []
    var storeId: String = "store"
    func evaluateAisles(using assetId: String, pinDropType: PinDropType, position: CGPoint, onCompletion: @escaping (Bool) -> Void) {}
}
class MockEventService: EventService {
    func cacheEvent(_ event: CompassEvent, position: CGPoint, aisle: String, allAisles: [String]?) {}

    func cacheAndBootstrapAsset(_ event: CompassEvent, position: CGPoint) async -> BootstrapStatus {
        .notBootstrapped
    }
}
class MockUserPositionManager: UserPositionManagement {
    var visibleFloor: CurrentValueSubject<IPSFloor?, Never> = .init(nil)
    var building: IPSBuilding? = nil
    func switchFloor(_ floor: IPSFloor) {}
}
// Add minimal stubs for types like IPSMap, IPSRoute, etc., if needed for compilation.
