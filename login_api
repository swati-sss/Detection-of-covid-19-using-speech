import SwiftUI

struct HomeView: View {
    @StateObject private var bridge = HomeViewModel()
    @State private var showAisleSheet = false
    @State private var showStaticPath = false
    @State private var showDistanceSheet = false

    @State private var didAutoInit = false

    @State private var showFeatureFlags = false
    @State private var showEnvironmentSheet = false

    @State private var showCustomMapSheet = false
    @State private var tempUseCustomMap = false
    @State private var tempStoreID = ""

    private var controlHeight: CGFloat = 44

    init(bridge: HomeViewModel = HomeViewModel()) {
        _bridge = StateObject(wrappedValue: bridge)
    }

    var body: some View {
        VStack(spacing: 5) {
            // top row
            HStack(spacing: 8) {
                TextField("Store ID", text: $bridge.storeIDText)
                    .textFieldStyle(.roundedBorder)
                    .frame(maxWidth: .infinity)
                Button(action: { bridge.initialize(false) }, label: {
                    Text("Initialize")
                        .font(.subheadline)
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 7)
                        .foregroundStyle(.white)
                })
                .background(
                    RoundedRectangle(cornerRadius: 8)
                        .fill(Color.blue)
                )

                Menu {
                    Button(action: { bridge.shouldZoomOnPins.toggle() }, label: {
                        Label(
                            "Zoom-in on pin drop",
                            systemImage: bridge.shouldZoomOnPins ? "checkmark.circle.fill" : "circle"
                        )
                    })

                    Button(action: { bridge.resetZoom.toggle() }, label: {
                        Label(
                            "Reset zoom on clear map",
                            systemImage: bridge.resetZoom ? "checkmark.circle.fill" : "circle"
                        )
                    })

                    Divider()

                    Button("Copy console text") {
                        bridge.copyConsoleTextToClipboard()
                    }

                    Button("Clear console") {
                        bridge.clearConsole()
                    }

                    Button(bridge.isConsoleHidden ? "Show console" : "Hide console") {
                        bridge.toggleConsoleVisibility()
                    }

                    Divider()

                    Button("Stop positioning", role: .destructive) {
                        bridge.stopPositioning()
                    }

                } label: {
                    Text("Options")
                        .font(.subheadline)
                        .foregroundColor(.white)
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 7)
                        .background(RoundedRectangle(cornerRadius: 8))
                }
            }
            .padding(.horizontal, 8)
            .padding(.top, 3)

            // Middle row
            HStack(spacing: 8) {
                Menu {
                    Text("Select a pin type")

                    Button("Aisle Pin") {
                        showAisleSheet = true
                    }
                    Button("Static Path") {
                        showStaticPath = true
                        showAisleSheet = true
                    }
                    Button("Get Distance") {
                        showDistanceSheet = true
                    }
                    Button("Test Hardcoded Distance") {
                        bridge.testGetUserDistanceWithHardcodedPin()
                    }
                    Button("Campaign Pin") {
                        bridge.displayCampaignPinSample()
                    }
                } label: {
                    Text("Display Pin")
                        .font(.subheadline)
                        .frame(maxWidth: .infinity)
                        .foregroundColor(.white)
                        .padding(.horizontal, 12)
                        .padding(.vertical, 8)
                        .background(RoundedRectangle(cornerRadius: 8))
                }

                Menu {
                    Text("Select API")

                    Button("Clear Map") {
                        bridge.clearMap()
                    }
                    Button("Get Location") {
                        bridge.getLocation(assetId: "1645190")
                    }
                    Button("Kill Switch") {
                        bridge.killSwitch()
                    }

                } label: {
                    Text("Other APIs")
                        .font(.subheadline)
                        .frame(maxWidth: .infinity)
                        .foregroundColor(.white)
                        .padding(.horizontal, 12)
                        .padding(.vertical, 8)
                        .background(RoundedRectangle(cornerRadius: 8))
                }
            }
            .padding(.horizontal, 8)
            .padding(.top, 3)

            // last row
            HStack(spacing: 8) {
                // Evaluate JS button added to call the JS evaluation example
                Button(action: { bridge.evaluateJsExample() }, label: {
                    Text("Evaluate JS")
                        .font(.subheadline)
                        .frame(maxWidth: .infinity)
                        .padding(.vertical, 7)
                        .foregroundStyle(.white)
                })
                .background(
                    RoundedRectangle(cornerRadius: 8)
                        .fill(Color.blue)
                )
            }
            .padding(.horizontal, 8)
            .padding(.top, 3)

            Button(action: {
                tempStoreID = bridge.customMapStoreIDText
                tempUseCustomMap = !bridge.customMapStoreIDText.isEmpty
                showCustomMapSheet = true
            }, label: {
                Text("Custom Map")
                    .font(.subheadline)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 7)
                    .foregroundStyle(.white)
            })
            .background(
                RoundedRectangle(cornerRadius: 8)
                    .fill(Color.blue)
                    .padding(.horizontal, 8)
            )
            .sheet(isPresented: $showCustomMapSheet) {
                NavigationView {
                    Form {
                        Section(header: Text("Settings")) {
                            Toggle("Load Custom Map", isOn: $tempUseCustomMap)

                            if tempUseCustomMap {
                                TextField("Store ID", text: $tempStoreID)
                                    .textInputAutocapitalization(.never)
                                    .disableAutocorrection(true)
                            }
                        }

                        Section {
                            Button("Apply") {
                                if tempUseCustomMap {
                                    bridge.customMapStoreIDText = tempStoreID
                                    bridge.storeIDText = tempStoreID
                                } else {
                                    bridge.customMapStoreIDText = ""
                                }
                                DispatchQueue.main.async {
                                    bridge.currentStore = nil
                                    bridge.initialize(false)
                                }
                                showCustomMapSheet = false
                            }
                            .frame(maxWidth: .infinity, alignment: .center)
                        }
                    }
                    .navigationTitle("Custom Map")
                    .navigationBarTitleDisplayMode(.inline)
                    .toolbar {
                        ToolbarItem(placement: .cancellationAction) {
                            Button("Cancel") {
                                showCustomMapSheet = false
                            }
                        }
                    }
                }
            }

            // Progress strip
            HStack(spacing: 8) {
                ProgressView(value: bridge.calibrationProgress)
                    .progressViewStyle(.linear)
                    .frame(height: 24)
                    .scaleEffect(y: 3, anchor: .center)
                    .tint(bridge.calibrationProgress >= 1.0 ? .green : .red)
                    .overlay(alignment: .leading) {
                        Text(" ‚ôæÔ∏è Calibration")
                            .font(.system(size: 10, weight: .bold))
                            .padding(.leading, 4)
                    }
                    .animation(.easeInOut, value: bridge.calibrationProgress)

                ProgressView(value: bridge.positioningProgress)
                    .progressViewStyle(.linear)
                    .frame(height: 24)
                    .scaleEffect(y: 3, anchor: .center)
                    .tint(bridge.positioningProgress >= 1.0 ? .green : .red)
                    .overlay(alignment: .leading) {
                        Text(" üö∂üèº Position")
                            .font(.system(size: 10, weight: .bold))
                            .padding(.leading, 4)
                    }
                    .animation(.easeInOut, value: bridge.positioningProgress)

                ProgressView(value: bridge.isPositionLocked ? 1.0 : 0.0)
                    .progressViewStyle(.linear)
                    .frame(height: 24)
                    .scaleEffect(y: 3, anchor: .center)
                    .tint(bridge.isPositionLocked ? .green : .red)
                    .overlay(alignment: .leading) {
                        Text(" üîí Position Lock")
                            .font(.system(size: 10, weight: .bold))
                            .padding(.leading, 4)
                    }
                    .animation(.easeInOut, value: bridge.isPositionLocked)
            }
            .frame(height: 12)
            .padding(.horizontal, 8)
            .padding(.top, 3)

            // Map area
//            MapRootHost(viewController: bridge.mapRootViewController)
//                .background(Color(.systemBackground))
//                .clipShape(RoundedRectangle(cornerRadius: 8))
//                .padding(.horizontal, 8)
//                .frame(maxWidth: .infinity, maxHeight: .infinity)
            KeyboardIgnoringMapHost(viewController: bridge.mapRootViewController)
                .padding(.horizontal, 8)

            if !bridge.isConsoleHidden {
                // Console
                ScrollViewReader { proxy in
                    ScrollView {
                        Text(bridge.consoleText.isEmpty ? "‚Äî console ‚Äî" : bridge.consoleText)
                            .font(.system(.footnote, design: .monospaced))
                            .frame(maxWidth: .infinity, alignment: .leading)
                            .padding(8)

                        Color.clear
                            .frame(height: 1)
                            .id("BOTTOM")
                    }
                    .frame(height: 160)
                    .background(.ultraThinMaterial, in: RoundedRectangle(cornerRadius: 8))
                    .overlay(
                        RoundedRectangle(cornerRadius: 8)
                            .stroke(Color.secondary.opacity(0.35))
                    )
                    .onChange(of: bridge.scrollToken) { _ in
                        withAnimation {
                            proxy.scrollTo("BOTTOM", anchor: .bottom)
                        }
                    }
                }
                .padding(.horizontal, 8)
                .padding(.bottom, 8)
            }
        }
        .onAppear {
            guard !didAutoInit else { return }
            didAutoInit = true
            DispatchQueue.main.async {
                bridge.initialize(false)
            }
        }
        .navigationTitle("Main Map")
        .navigationBarTitleDisplayMode(.inline)
        .sheet(isPresented: $showAisleSheet) {
            AislePinInputSheet { pins in
                let tuples = pins
                    .map {
                        HomeViewModel
                            .AisleTuple(zone: $0.zone, aisle: $0.aisle, section: $0.section, selected: $0.selected)
                    }
                bridge.displayPinsV2(pins: tuples, isStaticPathVisible: showStaticPath)
                showStaticPath = false
            }
            .presentationDetents([.medium, .large])
        }
        .sheet(isPresented: $showDistanceSheet) {
            DistanceInputSheet { zone, aisle, section in
                bridge.getUserDistance(zone: zone, aisle: aisle, section: section)
            }
            .presentationDetents([.medium])
        }
    }
}

#Preview {
    HomeView()
}
