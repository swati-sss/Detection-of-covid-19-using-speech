import SwiftUI
import LivingDesign

final class MapContainerViewController: UIViewController {
    let mapRoot: LDRootViewController

    init(mapRoot: LDRootViewController) {
        self.mapRoot = mapRoot
        super.init(nibName: nil, bundle: nil)
    }
    required init?(coder: NSCoder) { fatalError("init(coder:) has not been implemented") }

    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        rehostIfNeeded()
    }

    func rehostIfNeeded() {
        let child = mapRoot

        if let parent = child.parent, parent !== self {
            child.willMove(toParent: nil)
            child.view.removeFromSuperview()
            child.removeFromParent()
        }

        if child.parent !== self {
            addChild(child)
            child.didMove(toParent: self)
        }

        if child.view.superview !== view {
            let v = child.view!
            v.translatesAutoresizingMaskIntoConstraints = false
            view.addSubview(v)
            NSLayoutConstraint.activate([
                v.leadingAnchor.constraint(equalTo: view.safeAreaLayoutGuide.leadingAnchor),
                v.trailingAnchor.constraint(equalTo: view.safeAreaLayoutGuide.trailingAnchor),
                v.topAnchor.constraint(equalTo: view.topAnchor), 
                v.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor)
            ])
        }

        view.setNeedsLayout()
        view.layoutIfNeeded()
    }
}

struct MapRootHost: UIViewControllerRepresentable {
    let viewController: LDRootViewController

    func makeUIViewController(context: Context) -> MapContainerViewController {
        MapContainerViewController(mapRoot: viewController)
    }

    func updateUIViewController(_ uiViewController: MapContainerViewController, context: Context) {
        uiViewController.rehostIfNeeded()
    }
}

struct KeyboardIgnoringMapHost: View {
    let viewController: LDRootViewController

    var body: some View {
        GeometryReader { proxy in
            MapRootHost(viewController: viewController)
                .background(Color(.systemBackground))
                .clipShape(RoundedRectangle(cornerRadius: 8))
                .frame(width: proxy.size.width, height: proxy.size.height)
        }
        .ignoresSafeArea(.keyboard, edges: .bottom)
    }
}
