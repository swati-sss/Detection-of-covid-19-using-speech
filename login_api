import Combine
import compass_sdk_ios
import PluginAPIs
import UIKit
import WalmartPlatform

public class CompassPluginAPI: CompassAPI {
    private var compass: Compass?
    private var hasInitializeCalled = false
    private var webViewDelegateAdapter: WebViewMessageDelegateAdapter?

    public init() {}

    public func makeCompassViewController() -> UIViewController {
        if compass == nil {
            compass = Compass()
        }
        return compass!
    }

    public func initialize(
        authParameter: PluginAPIs.CompassAuthParameter,
        configuration: PluginAPIs.CompassConfiguration,
        rootViewController: UIViewController
    ) {
        if compass == nil {
            compass = Compass()
        }
        guard let compass = compass else { return }

        let sdkAuth = AuthParameter(
            authToken: authParameter.authToken,
            tokenType: authParameter.tokenType,
            accountID: authParameter.accountID,
            consumerID: authParameter.consumerID
        )

        let sdkSiteType = SiteType(rawValue: configuration.siteType.rawValue) ?? .Store
        let sdkBusinessUnit = BusinessUnitType(rawValue: configuration.businessUnitType.rawValue) ?? .WALMART

        let sdkConfig = Configuration(
            country: configuration.country,
            site: configuration.site,
            userId: configuration.userId,
            siteType: sdkSiteType,
            manualPinDrop: configuration.manualPinDrop,
            navigateToPin: configuration.navigateToPin,
            multiPin: configuration.multiPin,
            searchBar: configuration.searchBar,
            centerMap: configuration.centerMap,
            locationIngestion: configuration.locationIngestion,
            mockUser: configuration.mockUser,
            anonymizedUserID: configuration.anonymizedUserID,
            startPositioning: configuration.startPositioning,
            automaticCalibration: configuration.automaticCalibration,
            businessUnitType: sdkBusinessUnit,
            mapType: configuration.mapType
        )

        hasInitializeCalled = true
        compass.initialize(
            authParameter: sdkAuth,
            configuration: sdkConfig,
            capabilities: [.storeMap],
            rootViewController: rootViewController,
            customMapRequest: nil
        )
    }

    public func displayMap(workflow: PluginAPIs.CompassWorkflow?) {
        guard let compass = compass else { return }
        var sdkWorkflow: Workflow?
        if let w = workflow {
            sdkWorkflow = Workflow(id: w.id, type: w.type, value: w.value)
        }
        compass.displayMap(workflow: sdkWorkflow)
    }

    public func startPositioning() {
        compass?.startPositioning()
    }

    public func stopPositioning() {
        compass?.stopPositioning()
    }

    public func setEnvironment(_ environment: PluginAPIs.CompassEnvironment) {
        let sdkEnv = compass_sdk_ios.CompassEnvironment(rawValue: environment.rawValue) ?? .production
        compass?.setEnvironment(sdkEnv)
    }

    public func updateAuthParams(token: String, tokenType: String, consumerID: String, accountID: String) {
        compass?.updateAuthParams(token: token, tokenType: tokenType, consumerID: consumerID, accountID: accountID)
    }

    public func clearMap(configuration: [String: Any]?) {
        compass?.clearMap(configuration: configuration)
    }

    public func resetPositionStatusEvent() {
        compass?.resetPositionStatusEvent()
    }

    public func killSwitch() {
        compass?.killSwitch()
    }

    public func displayPin(uuidList: [String], idType: CompassPinDropMethod, config: [String: Any]?) {
        let sdkIdType = compass_sdk_ios.PinDropMethod(rawValue: idType.rawValue) ?? .generic
        compass?.displayPin(uuidList: uuidList, idType: sdkIdType, config: config)
    }

    public func displayPin(
        pins: [PluginAPIs.CompassPin],
        config: [String: Any]?,
        isZoomOutRequired: Bool
    ) {
        let sdkPins = pins.map { pin -> compass_sdk_ios.CompassPin in
            switch pin {
            case .aisle(let aislePin):
                let location = compass_sdk_ios.AisleLocation(
                    zone: aislePin.location.zone,
                    aisle: aislePin.location.aisle,
                    section: aislePin.location.section,
                    selected: aislePin.location.selected
                )
                let sdkAislePin = compass_sdk_ios.AislePin(type: aislePin.type, id: aislePin.id, location: location)
                return .aisle(sdkAislePin)
            case .campaign(let campaignPin):
                let sdkCampaignPin = compass_sdk_ios.CampaignPin(
                    type: campaignPin.type,
                    id: campaignPin.id,
                    selected: campaignPin.selected
                )
                return .campaign(sdkCampaignPin)
            }
        }
        compass?.displayPin(pins: sdkPins, config: config, isZoomOutRequired: isZoomOutRequired)
    }

    public func displayStaticPath(
        pins: [PluginAPIs.CompassPin],
        startFromNearbyEntrance: Bool,
        disableZoomGestures: Bool
    ) {
        let sdkPins = pins.map { pin -> compass_sdk_ios.CompassPin in
            switch pin {
            case .aisle(let aislePin):
                let location = compass_sdk_ios.AisleLocation(
                    zone: aislePin.location.zone,
                    aisle: aislePin.location.aisle,
                    section: aislePin.location.section,
                    selected: aislePin.location.selected
                )
                let sdkAislePin = compass_sdk_ios.AislePin(type: aislePin.type, id: aislePin.id, location: location)
                return .aisle(sdkAislePin)
            case .campaign(let campaignPin):
                let sdkCampaignPin = compass_sdk_ios.CampaignPin(
                    type: campaignPin.type,
                    id: campaignPin.id,
                    selected: campaignPin.selected
                )
                return .campaign(sdkCampaignPin)
            }
        }
        compass?.displayStaticPath(
            pins: sdkPins,
            startFromNearbyEntrance: startFromNearbyEntrance,
            disableZoomGestures: disableZoomGestures
        )
    }

    public func getUserDistance(
        pins: [PluginAPIs.CompassAislePin],
        completion: PluginAPIs.CompassUserDistanceCompleteHandler?
    ) {
        let sdkPins = pins.map { aislePin -> compass_sdk_ios.AislePin in
            let location = compass_sdk_ios.AisleLocation(
                zone: aislePin.location.zone,
                aisle: aislePin.location.aisle,
                section: aislePin.location.section,
                selected: aislePin.location.selected
            )
            return compass_sdk_ios.AislePin(type: aislePin.type, id: aislePin.id, location: location)
        }

        compass?.getUserDistance(pins: sdkPins, completion: { responses in
            let mapped = responses.map { response in
                PluginAPIs.CompassUserDistanceResponse(data: response.toDictionary())
            }
            completion?(mapped)
        })
    }

    public func getAisle(id: String) {
        compass?.getAisle(id: id)
    }

    public func updateEvent(compassEvent: PluginAPIs.CompassEvent) {
        let sdkEvent = compass_sdk_ios.CompassEvent(
            eventType: compassEvent.eventType,
            eventValue: compassEvent.eventValue,
            eventMetadata: compassEvent.eventMetadata
        )
        compass?.updateEvent(compassEvent: sdkEvent)
    }

    public func updateEventList(namespace: String, eventType: String, eventValue: String, metaData: [String: Any]?) {
        compass?.updateEventList(namespace: namespace, eventType: eventType, eventValue: eventValue, metaData: metaData)
    }

    public var state: AnyPublisher<PluginAPIs.CompassInitializationState, Never> {
        guard let compass = compass else {
            return Just(PluginAPIs.CompassInitializationState.notInitialized).eraseToAnyPublisher()
        }

        let initState = compass.isFinishedInitialize
            .map { [weak self] value -> PluginAPIs.CompassInitializationState in
                guard let value = value else {
                    return (self?.hasInitializeCalled ?? false)
                        ? .initializationInProgress
                        : .notInitialized
                }
                if value {
                    return .initializationComplete
                }
                return .initializationFailed("Initialization failed")
            }

        let mapLoaded = compass.isFinishedSettingMap
            .filter { $0 }
            .map { _ in PluginAPIs.CompassInitializationState.mapLoaded }

        return initState.merge(with: mapLoaded).eraseToAnyPublisher()
    }

    public var isBlueDotEnabled: CurrentValueSubject<Bool?, Never> {
        return compass?.isBlueDotEnabled ?? CurrentValueSubject<Bool?, Never>(nil)
    }

    public var currentStore: Int? {
        return compass?.currentStore
    }

    public func getStatusService() -> CompassStatusService? {
        guard let statusService = compass?.getStatusService() else {
            return nil
        }
        return StatusServiceAdapter(statusService: statusService)
    }

    public func setWebViewMessageDelegate(_ delegate: CompassWebViewMessageDelegate?) {
        if let delegate {
            let adapter = WebViewMessageDelegateAdapter(delegate: delegate)
            webViewDelegateAdapter = adapter
            compass?.setWebViewMessageDelegate(adapter)
        } else {
            webViewDelegateAdapter = nil
            compass?.setWebViewMessageDelegate(nil)
        }
    }

    public func evaluateJSOnWebView(_ string: String) {
        compass?.evaluateJSOnWebView(string)
    }

    public func setEventEmitterHandler(_ handler: @escaping (CompassEventEmitter) -> Void) {
        guard let compass = compass else { return }
        var statusService = compass.getStatusService()
        statusService.eventEmitterHandler = { [weak self] sdkEvent in
            guard let self = self else { return }

            // Map SDK event type to API event type
            let sdkEventTypeString = sdkEvent.eventType.rawValue
            let apiEventType = CompassEventType(rawValue: sdkEventTypeString) ?? .noEvent

            // Create generic event wrapper
            let genericEvent = CompassGenericEvent(
                eventType: apiEventType,
                data: sdkEvent.toDictionary()
            )

            handler(genericEvent)
        }
    }
}

private final class WebViewMessageDelegateAdapter: compass_sdk_ios.WebViewMessageDelegate {
    private weak var delegate: PluginAPIs.CompassWebViewMessageDelegate?

    init(delegate: PluginAPIs.CompassWebViewMessageDelegate) {
        self.delegate = delegate
    }

    func didReceiveWebViewMessage(_ message: String) {
        delegate?.didReceiveWebViewMessage(message)
    }
}

private final class StatusServiceAdapter: CompassStatusService {
    private let statusService: compass_sdk_ios.StatusService

    init(statusService: compass_sdk_ios.StatusService) {
        self.statusService = statusService
    }

    func emitMapStatusEvent(isSuccess: Bool) {
        statusService.emitMapStatusEvent(isSuccess: isSuccess)
    }

    func emitLocationEvent(assetLocation: String) {
        statusService.emitLocationEvent(assetLocation: assetLocation)
    }
}
