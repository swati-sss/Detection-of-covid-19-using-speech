import UIKit
@_implementationOnly import LivingDesign
@_implementationOnly import Bogle

final class ReviewSectionBottomSheet: LDRootViewController {
    weak var bottomSheetableActionDelegate: LDBottomSheetableActionDelegate?
    
    struct Model {
        let title = "Review section"
        let missingCount: Int
        let misplacedCount: Int
        let unknownCount: Int
        let correctCount: Int
        let tryAgainText = "Try again"
        let doneButtonText = "Done"
        let filterByText = "Filter By"
        
        init(missingCount: Int = 0, misplacedCount: Int = 0, unknownCount: Int = 0, correctCount: Int = 0) {
            self.missingCount = missingCount
            self.misplacedCount = misplacedCount
            self.unknownCount = unknownCount
            self.correctCount = correctCount
        }
    }
    
    var model: Model {
        didSet {
            applyModel()
        }
    }
    
    // State
    private var isExpanded = false
    
    // UI Elements
    private let expandButton = UIButton()
    private let collapseButton = UIButton()
    private let titleLabel = LDLabel(style: .headingMedium)
    private let statsContainer = UIView()
    private let statsLabel = UILabel()
    
    // Filter section
    private let filterByLabel = LDLabel(style: .bodySmall)
    private let missingCheckbox = FilterItemView()
    private let misplacedCheckbox = FilterItemView()
    private let unknownCheckbox = FilterItemView()
    private let correctCheckbox = FilterItemView()
    
    private let divider = LDDivider(style: .horizontal)
    private let buttonStackView = UIStackView()
    private let tryAgainButton = UIButton()
    private let doneButton = LDButton(variant: .primary, size: .large)
    
    // Callbacks
    private let onTryAgain: () -> Void
    private let onDone: () -> Void
    
    init(model: Model, onTryAgain: @escaping () -> Void, onDone: @escaping () -> Void) {
        self.model = model
        self.onTryAgain = onTryAgain
        self.onDone = onDone
        super.init(nibName: nil, bundle: nil)
        applyModel()
    }
    
    override func constructView() {
        super.constructView()
        
        expandButton.addTarget(self, action: #selector(handleExpandTapped), for: .primaryActionTriggered)
        collapseButton.addTarget(self, action: #selector(handleCollapseTapped), for: .primaryActionTriggered)
        tryAgainButton.addTarget(self, action: #selector(handleTryAgainTapped), for: .primaryActionTriggered)
        doneButton.addTarget(self, action: #selector(handleDoneTapped), for: .primaryActionTriggered)
        
        // Configure button stack view
        buttonStackView.axis = .horizontal
        buttonStackView.spacing = LDSpacing.space16
        buttonStackView.distribution = .fill
        buttonStackView.alignment = .fill
        
        // Initially hide filter items
        filterByLabel.isHidden = true
        missingCheckbox.isHidden = true
        misplacedCheckbox.isHidden = true
        unknownCheckbox.isHidden = true
        correctCheckbox.isHidden = true
    }
    
    override func constructSubviewHierarchy() {
        super.constructSubviewHierarchy()
        
        view.addAutoLayoutSubview(expandButton)
        view.addAutoLayoutSubview(collapseButton)
        view.addAutoLayoutSubview(titleLabel)
        view.addAutoLayoutSubview(statsContainer)
        statsContainer.addAutoLayoutSubview(statsLabel)
        
        // Add filter items
        view.addAutoLayoutSubview(filterByLabel)
        view.addAutoLayoutSubview(missingCheckbox)
        view.addAutoLayoutSubview(misplacedCheckbox)
        view.addAutoLayoutSubview(unknownCheckbox)
        view.addAutoLayoutSubview(correctCheckbox)
        
        view.addAutoLayoutSubview(divider)
        view.addAutoLayoutSubview(buttonStackView)
        buttonStackView.addArrangedSubview(tryAgainButton)
        buttonStackView.addArrangedSubview(doneButton)
    }
    
    override func constructSubviewLayoutConstraints() {
        super.constructSubviewLayoutConstraints()
        
        NSLayoutConstraint.activate([
            // Expand/Collapse buttons - moved up
            expandButton.topAnchor.constraint(equalTo: view.topAnchor, constant: LDSpacing.space8),
            expandButton.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            expandButton.widthAnchor.constraint(equalToConstant: LDSpacing.space24),
            expandButton.heightAnchor.constraint(equalToConstant: LDSpacing.space24),
            
            collapseButton.topAnchor.constraint(equalTo: view.topAnchor, constant: LDSpacing.space8),
            collapseButton.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            collapseButton.widthAnchor.constraint(equalToConstant: LDSpacing.space24),
            collapseButton.heightAnchor.constraint(equalToConstant: LDSpacing.space24),
            
            // Title - moved up
            titleLabel.topAnchor.constraint(equalTo: view.topAnchor, constant: LDSpacing.space8),
            titleLabel.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            
            // Stats container
            statsContainer.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: LDSpacing.space16),
            statsContainer.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            statsContainer.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            statsContainer.heightAnchor.constraint(equalToConstant: LDSpacing.space32),
            
            statsLabel.centerXAnchor.constraint(equalTo: statsContainer.centerXAnchor),
            statsLabel.centerYAnchor.constraint(equalTo: statsContainer.centerYAnchor),
            
            // Filter By label
            filterByLabel.topAnchor.constraint(equalTo: statsContainer.bottomAnchor, constant: LDSpacing.space16),
            filterByLabel.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            
            // Checkboxes
            missingCheckbox.topAnchor.constraint(equalTo: filterByLabel.bottomAnchor, constant: LDSpacing.space12),
            missingCheckbox.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            missingCheckbox.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            
            misplacedCheckbox.topAnchor.constraint(equalTo: missingCheckbox.bottomAnchor, constant: LDSpacing.space12),
            misplacedCheckbox.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            misplacedCheckbox.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            
            unknownCheckbox.topAnchor.constraint(equalTo: misplacedCheckbox.bottomAnchor, constant: LDSpacing.space12),
            unknownCheckbox.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            unknownCheckbox.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            
            correctCheckbox.topAnchor.constraint(equalTo: unknownCheckbox.bottomAnchor, constant: LDSpacing.space12),
            correctCheckbox.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            correctCheckbox.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            
            // Divider
            divider.topAnchor.constraint(equalTo: isExpanded ? correctCheckbox.bottomAnchor : statsContainer.bottomAnchor, constant: LDSpacing.space16),
            divider.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            divider.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            divider.heightAnchor.constraint(equalToConstant: 1),
            
            // Button stack (horizontal)
            buttonStackView.topAnchor.constraint(equalTo: divider.bottomAnchor, constant: LDSpacing.space16),
            buttonStackView.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: LDSpacing.space16),
            buttonStackView.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: -LDSpacing.space16),
            buttonStackView.heightAnchor.constraint(equalToConstant: LDSpacing.space40),
            buttonStackView.bottomAnchor.constraint(equalTo: view.bottomAnchor, constant: -LDSpacing.space16),
            
            // Try again button width
            tryAgainButton.widthAnchor.constraint(equalToConstant: 100),
            
            // Done button takes remaining space
            doneButton.widthAnchor.constraint(greaterThanOrEqualToConstant: 200)
        ])
    }
    
    private func applyModel() {
        // Expand/Collapse buttons
        expandButton.setImage(LDIcon.chevronDown.image, for: .normal)
        collapseButton.setImage(LDIcon.close.image, for: .normal)
        
        // Title
        titleLabel.font = UIFont.bogle(ofSize: LDSpacing.space20, weight: .bold)
        titleLabel.textAlignment = .center
        titleLabel.text = model.title
        
        // Stats
        let attributedString = NSMutableAttributedString()
        
        // Missing
        let missingAttachment = NSTextAttachment()
        missingAttachment.image = UIImage(systemName: "exclamationmark.circle.fill")?.withTintColor(.red, renderingMode: .alwaysOriginal)
        missingAttachment.bounds = CGRect(x: 0, y: -2, width: 16, height: 16)
        attributedString.append(NSAttributedString(attachment: missingAttachment))
        attributedString.append(NSAttributedString(string: " Missing (\(model.missingCount))  ", attributes: [
            .font: UIFont.bogle(ofSize: 14, weight: .regular),
            .foregroundColor: UIColor.black
        ]))
        
        // Misplaced
        let misplacedAttachment = NSTextAttachment()
        misplacedAttachment.image = UIImage(systemName: "exclamationmark.triangle.fill")?.withTintColor(.systemYellow, renderingMode: .alwaysOriginal)
        misplacedAttachment.bounds = CGRect(x: 0, y: -2, width: 16, height: 16)
        attributedString.append(NSAttributedString(attachment: misplacedAttachment))
        attributedString.append(NSAttributedString(string: " Misplaced (\(model.misplacedCount))  ", attributes: [
            .font: UIFont.bogle(ofSize: 14, weight: .regular),
            .foregroundColor: UIColor.black
        ]))
        
        // Unknown
        let unknownAttachment = NSTextAttachment()
        unknownAttachment.image = UIImage(systemName: "circle.fill")?.withTintColor(.orange, renderingMode: .alwaysOriginal)
        unknownAttachment.bounds = CGRect(x: 0, y: -2, width: 16, height: 16)
        attributedString.append(NSAttributedString(attachment: unknownAttachment))
        attributedString.append(NSAttributedString(string: " Unknown (\(model.unknownCount))", attributes: [
            .font: UIFont.bogle(ofSize: 14, weight: .regular),
            .foregroundColor: UIColor.black
        ]))
        
        statsLabel.attributedText = attributedString
        
        // Filter By label
        filterByLabel.text = model.filterByText
        filterByLabel.font = UIFont.bogle(ofSize: 14, weight: .regular)
        filterByLabel.textColor = UIColor.gray
        
        // Configure checkboxes
        missingCheckbox.configure(title: "Missing items (\(model.missingCount))")
        misplacedCheckbox.configure(title: "Misplaced items (\(model.misplacedCount))")
        unknownCheckbox.configure(title: "Unknown items (\(model.unknownCount))")
        correctCheckbox.configure(title: "Correct items (\(model.correctCount))")
        
        // Try again button
        let tryAgainAttributes: [NSAttributedString.Key: Any] = [
            .font: UIFont.bogle(ofSize: LDSpacing.space16, weight: .regular),
            .foregroundColor: UIColor.black,
            .underlineStyle: NSUnderlineStyle.single.rawValue
        ]
        tryAgainButton.setAttributedTitle(NSAttributedString(string: model.tryAgainText, attributes: tryAgainAttributes), for: .normal)
        
        // Done button
        doneButton.dataModel = LDButton.Model(
            variant: .primary,
            size: .large,
            text: model.doneButtonText
        )
    }
    
    @objc private func handleExpandTapped() {
        isExpanded = true
        
        // Update button icon
        expandButton.setImage(LDIcon.chevronUp.image, for: .normal)
        
        // Show filter items
        filterByLabel.isHidden = false
        missingCheckbox.isHidden = false
        misplacedCheckbox.isHidden = false
        unknownCheckbox.isHidden = false
        correctCheckbox.isHidden = false
        
        // Re-layout
        view.setNeedsLayout()
        view.layoutIfNeeded()
    }
    
    @objc private func handleCollapseTapped() {
        self.dismiss(animated: true)
    }
    
    @objc private func handleTryAgainTapped() {
        self.dismiss(animated: true) {
            self.onTryAgain()
        }
    }
    
    @objc private func handleDoneTapped() {
        self.dismiss(animated: true) {
            self.onDone()
        }
    }
}

// MARK: - LDBottomSheetable
extension ReviewSectionBottomSheet: LDBottomSheetable {
    var contentView: UIView { view }
    var tiersType: LDBottomSheetTierType { .oneTierAutomatic }
    var isDismissable: Bool { true }
    var shouldHideGrabber: Bool { true }
    var shouldIgnoreTabBar: Bool { true }
}

// MARK: - FilterItemView
class FilterItemView: UIView {
    private let checkbox = UIButton()
    private let titleLabel = UILabel()
    private var isChecked = false
    
    override init(frame: CGRect) {
        super.init(frame: frame)
        setupView()
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    private func setupView() {
        checkbox.setImage(UIImage(systemName: "square"), for: .normal)
        checkbox.setImage(UIImage(systemName: "checkmark.square.fill"), for: .selected)
        checkbox.tintColor = .black
        checkbox.addTarget(self, action: #selector(checkboxTapped), for: .touchUpInside)
        
        titleLabel.font = UIFont.bogle(ofSize: 14, weight: .regular)
        titleLabel.textColor = .black
        
        addSubview(checkbox)
        addSubview(titleLabel)
        
        checkbox.translatesAutoresizingMaskIntoConstraints = false
        titleLabel.translatesAutoresizingMaskIntoConstraints = false
        
        NSLayoutConstraint.activate([
            checkbox.leadingAnchor.constraint(equalTo: leadingAnchor),
            checkbox.centerYAnchor.constraint(equalTo: centerYAnchor),
            checkbox.widthAnchor.constraint(equalToConstant: 24),
            checkbox.heightAnchor.constraint(equalToConstant: 24),
            
            titleLabel.leadingAnchor.constraint(equalTo: checkbox.trailingAnchor, constant: 12),
            titleLabel.trailingAnchor.constraint(equalTo: trailingAnchor),
            titleLabel.centerYAnchor.constraint(equalTo: centerYAnchor),
            
            heightAnchor.constraint(equalToConstant: 30)
        ])
    }
    
    func configure(title: String) {
        titleLabel.text = title
    }
    
    @objc private func checkboxTapped() {
        isChecked.toggle()
        checkbox.isSelected = isChecked
    }
}
